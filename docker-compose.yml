version: "3.8"


x-mock-shared-vars: &mock-shared-vars
  CHAN_HOST: http://mock-4channel:3000

x-live-shared-vars: &live-shared-vars
  CHAN_HOST: https://a.4cdn.org

services:

  live-python:
    build: ./python
    command: flask --app main run --debug --host=0.0.0.0
    ports: [8001:5000]
    volumes: [./python/src:/app]
    environment:
      <<: *live-shared-vars

  mocked-python:
    build: ./python
    command: flask --app main run --debug --host=0.0.0.0
    ports: [8011:5000]
    volumes: [./python/src:/app]
    depends_on: [mock-4channel]
    environment:
      <<: *mock-shared-vars

  live-go:
    build: 
      context: ./go
      target: dev
    command: ["CompileDaemon", "-directory=/app/", "-polling", "-build=go build -a -tags netgo -o ./service", "-command=/app/service"]
    ports: [8002:8080]
    volumes: [./go/src:/app]
    environment:
      <<: *live-shared-vars
  
  mocked-go:
    build: 
      context: ./go
      target: dev
    command: ["CompileDaemon", "-directory=/app/", "-polling", "-build=go build -a -tags netgo -o ./service", "-command=/app/service"]
    ports: [8012:8080]
    volumes: [./go/src:/app]
    depends_on: [mock-4channel]
    environment:
      <<: *mock-shared-vars

  live-javascript:
    build: ./javascript
    command: nodemon --legacy-watch src/index.js
    init: true
    ports: [8003:3000]
    volumes: [./javascript/src:/app/src]
    environment:
      <<: *live-shared-vars

  mocked-javascript:
    build: ./javascript
    command: nodemon --legacy-watch src/index.js
    init: true
    ports: [8013:3000]
    volumes: [./javascript/src:/app/src]
    depends_on: [mock-4channel]
    environment:
      <<: *mock-shared-vars

  mock-4channel:
    build: ./mocks/mock-4channel
    volumes: [./mocks/mock-4channel:/app]
    ports: [8051:3000]
    command: nodemon --legacy-watch src/index.js

  swagger-ui:
    image: swaggerapi/swagger-ui
    ports: [9001:8080]
    environment:
      URL: "http://localhost:9002/swagger.yml"
    depends_on:
      - schema-host
      - live-python
      - live-go
      - live-javascript
      - mocked-python
      - mocked-go
      - mocked-javascript
  
  schema-host:
    build: ./schema
    volumes: [./schema:/app/public]
    ports: [9002:80]

  mock-functional-test:
    build: ./tests/functional
    volumes: [./tests/functional:/tests]
    depends_on:
      - mocked-python
      - mocked-go
      - mocked-javascript
    init: true
    command: ptw --poll -- ./mock
